<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Surat untuk Sayang ğŸ’Œ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700&display=swap" rel="stylesheet">
  <meta name="theme-color" content="#ffd6c2">
  <style>
    :root{
      --bg:#fde8df; --grid:#f6cfc3; --choco:#6b3f2a; --accent:#ffb4a2; --cream:#fff7f2;
    }
    html,body{height:100%}
    body{font-family:'Quicksand',system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .pastel-grid{background-color:var(--bg);background-image:linear-gradient(to right,var(--grid) 1px,transparent 1px),linear-gradient(to bottom,var(--grid) 1px,transparent 1px);background-size:40px 40px}
    .speech{filter:drop-shadow(4px 6px 0 rgba(107,63,42,.15));border:2.5px solid var(--choco);background:var(--cream);position:relative}
    .speech:after{content:"";position:absolute;left:28px;bottom:-14px;width:18px;height:18px;background:var(--cream);border-left:2.5px solid var(--choco);border-bottom:2.5px solid var(--choco);transform:skewX(-20deg) rotate(45deg)}
    .window{border:3px solid var(--choco);background:white;box-shadow:0 16px 40px rgba(0,0,0,.15)}
    .winbar{background:#ffd9cc;border-bottom:3px solid var(--choco)}
    .btn{border:2.5px solid var(--choco);background:#ffd6c2}
    .btn:active{transform:translateY(1px)}
    .floaty{animation:floaty 3.2s ease-in-out infinite}
    @keyframes floaty{0%,100%{transform:translateY(0)}50%{transform:translateY(-6px)}}
    .hide{display:none}

    /* GAME 1: falling items */
    .arena{position:relative;overflow:hidden}
    @keyframes fallTop{
      from { top:-80px; transform:rotate(0deg); }
      to   { top: calc(100% + 100px); transform:rotate(360deg); }
    }
    .fall-item{
      position:absolute;
      top:-80px;
      width:58px;height:58px;
      display:grid;place-items:center;
      border-radius:9999px;cursor:pointer;user-select:none;
      will-change: top, transform;
    }
    .fall-item.heart{background:#ffd1dc;border:3px solid var(--choco);font-size:28px}
    .fall-item.star{background:#fff1b8;border:3px solid var(--choco);font-size:26px}
    .fall-item.photoRound{background-size:cover;background-position:center;border:3px solid var(--choco)}
    .fall-item.bomb{background-size:cover;background-position:center;border:3px solid #c0392b;box-shadow:0 0 0 3px #ffe6e6 inset}
    .pop{animation:pop .25s ease}
    @keyframes pop{from{transform:scale(1)}to{transform:scale(1.25);opacity:.2}}

    /* GAME 2: cute math (Kraepelin mode + feedback salah) */
    .key{border:2px solid rgba(107,63,42,.4)}
    .shake{animation:shake .2s ease}
    @keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-4px)}75%{transform:translateX(4px)}}

    .wrongFlash{animation:wrongFlash .5s ease}
    @keyframes wrongFlash{
      0%{background:#ffeaea;border-color:#d33;transform:scale(1)}
      50%{background:#ffd9d9;border-color:#d33;transform:scale(1.025)}
      100%{background:var(--cream);border-color:var(--choco);transform:scale(1)}
    }

    /* confetti */
    .confetti{position:fixed;left:0;top:0;width:100%;height:100%;pointer-events:none}
    .confetti span{position:absolute;animation:conf .9s linear forwards;font-size:22px}
    @keyframes conf{to{transform:translateY(120vh) rotate(720deg);opacity:0}}

    /* === Finale Card Animations === */
    .cake-bounce { animation: cakeBounce 1.8s ease-in-out infinite; transform-origin: bottom center; }
    @keyframes cakeBounce { 0%,100% { transform: translateY(0) scale(1);} 50% { transform: translateY(-6px) scale(1.02);} }
    .candle-flicker { animation: candleFlicker .9s ease-in-out infinite; filter: drop-shadow(0 0 6px rgba(255, 200, 80, .9)); }
    @keyframes candleFlicker { 0%,100% { opacity:.85; transform: translateY(0) rotate(0deg);} 50% { opacity:1; transform: translateY(-1px) rotate(2deg);} }
    .hb-wave { animation: hbWave 2.2s ease-in-out infinite; }
    @keyframes hbWave { 0%,100% { letter-spacing:.5px; transform: scale(1);} 50% { letter-spacing:1.5px; transform: scale(1.02);} }
  </style>
</head>
<body class="pastel-grid min-h-screen flex items-center justify-center">
  <main class="relative w-full max-w-md sm:max-w-lg md:max-w-xl p-6">
    <!-- dekor -->
    <div class="absolute -top-4 right-6 rotate-3 select-none">ğŸ˜Š</div>
    <div class="absolute top-16 left-4 -rotate-6 text-xl select-none">â­</div>
    <div class="absolute bottom-24 right-3 rotate-6 select-none">ğŸ’Œ</div>

    <!-- Landing -->
    <div id="landing" class="text-center">
      <div class="speech rounded-xl px-5 py-3 text-[17px] sm:text-lg font-semibold text-[var(--choco)] inline-block">
        maaf cantikk, boleh ganggu waktunya sebentar? aku ada sesuatu buat kamu ğŸ¤«
      </div>
      <button id="openBtn" class="mt-8 floaty rounded-2xl p-6 border-[3px] border-[var(--choco)] bg-[var(--cream)]">
        ğŸ‘‰ Klik di sini dulu
      </button>
      <div class="mt-8 text-[var(--choco)]/70 text-sm">Special buat ayanggâ¤ï¸</div>
    </div>

    <!-- CARD 1 -->
    <section id="card1" class="hide">
      <div class="window rounded-2xl overflow-hidden">
        <div class="winbar px-4 py-2 flex items-center justify-between"><div class="font-semibold text-[var(--choco)]">Halo sayang</div></div>
        <div class="p-6 text-center text-[var(--choco)]">
          <p class="text-lg">makasih ya udah mau klikâ€¦ aku cuma butuh kamu sebentar aja kok ğŸ˜Š</p>
          <p class="mt-2">siap lanjut?</p>
          <button id="toCard2" class="btn mt-4 rounded-xl px-6 py-2 font-semibold text-[var(--choco)]">Iya, ayo lanjut</button>
        </div>
      </div>
    </section>

    <!-- CARD 2 -->
    <section id="card2" class="hide">
      <div class="window rounded-2xl overflow-hidden">
        <div class="winbar px-4 py-2"><div class="font-semibold text-[var(--choco)]">Misi Mini</div></div>
        <div class="p-6 text-center text-[var(--choco)]">
          <p class="text-lg">sebelum aku kasih â€˜sesuatuâ€™, ada misi kecil buat kamu nih âœ¨</p>
          <button id="startG1" class="btn mt-4 rounded-xl px-6 py-2 font-semibold text-[var(--choco)]">Mulai Misi</button>
        </div>
      </div>
    </section>

    <!-- GAME 1 -->
    <section id="game1" class="hide">
      <div class="window rounded-2xl overflow-hidden">
        <div class="winbar px-4 py-2 flex justify-between items-center">
          <div class="text-[var(--choco)] font-semibold">Misi 1: Tangkap yang manis, hindari yang berbahaya ğŸ˜</div>
          <div class="text-[var(--choco)]"><span id="g1Score">0</span>/<span id="g1Target">15</span> Â· â± <span id="g1Time">25</span>s <span id="g1LivesWrap" class="ml-2"></span></div>
        </div>
        <div class="p-4">
          <div id="arena" class="arena h-[360px] rounded-2xl bg-[var(--cream)]/70 border-2 border-[var(--choco)]"></div>
          <div class="mt-3 text-center text-[var(--choco)]/80 text-sm">ketuk ğŸ’—/â­ buat dapetin poinâ€¦ hati-hati jangan sampai kena fotoku ğŸ™ˆ</div>
        </div>
      </div>
    </section>

    <!-- PILIHAN LANJUT (setelah G1) -->
    <section id="afterG1" class="hide">
      <div class="window rounded-2xl overflow-hidden">
        <div class="winbar px-4 py-2"><div class="font-semibold text-[var(--choco)]">Yay! ğŸ‰</div></div>
        <div class="p-6 text-center text-[var(--choco)]">
          <p class="text-lg">wah keren, kamu berhasil ğŸ‰<br>sekarang pilih, mau langsung aku kasih sesuatu atau lanjut main lagi?</p>
          <div class="mt-4 flex flex-col sm:flex-row gap-3 justify-center">
            <button id="giveUpBtn" class="btn rounded-xl px-6 py-2 font-semibold text-[var(--choco)]">Menyerah ğŸ˜¢</button>
            <button id="toG2" class="btn rounded-xl px-6 py-2 font-semibold text-[var(--choco)]">Lanjut Misi 2 â•</button>
          </div>
        </div>
      </div>
    </section>

    <!-- GIVE UP CARD -->
    <section id="giveUp" class="hide">
      <div class="window rounded-2xl overflow-hidden">
        <div class="winbar px-4 py-2"><div class="font-semibold text-[var(--choco)]">Eits...</div></div>
        <div class="p-6 text-center text-[var(--choco)]">
          <p class="text-lg">kamu gak sayang aku? ğŸ˜¢</p>
          <button id="giveUpContinue" class="btn mt-4 rounded-xl px-6 py-2 font-semibold text-[var(--choco)]">Lanjuuutt â¤ï¸</button>
        </div>
      </div>
    </section>

    <!-- GAME 2: CUTE MATH (Kraepelin) -->
    <section id="game2" class="hide">
      <div class="window rounded-2xl overflow-hidden">
        <div class="winbar px-4 py-2 flex justify-between items-center">
          <div class="text-[var(--choco)] font-semibold">Misi 2: Matematika Cinta ğŸ’•</div>
          <div class="text-[var(--choco)]">Skor: <span id="g2Score">0</span> Â· â± <span id="g2Time">60</span></div>
        </div>
        <div class="p-4 space-y-4">
          <div id="qBox" class="rounded-2xl bg-[var(--cream)]/80 border-2 border-[var(--choco)] text-center py-6 text-[var(--choco)]">
            <div class="text-4xl" id="qA">5</div>
            <div class="text-2xl">+</div>
            <div class="text-4xl" id="qB">7</div>
            <div class="mt-2 text-sm opacity-70">jawab hitungan ini dengan cepat ya, waktumu 60 detik â±<br>kalau berhasil, ada kejutan lebih seru ğŸŠ</div>
          </div>
          <div class="grid grid-cols-3 gap-3">
            <button class="key rounded-xl py-4 text-xl bg-white" data-k="1">1</button>
            <button class="key rounded-xl py-4 text-xl bg-white" data-k="2">2</button>
            <button class="key rounded-xl py-4 text-xl bg-white" data-k="3">3</button>
            <button class="key rounded-xl py-4 text-xl bg-white" data-k="4">4</button>
            <button class="key rounded-xl py-4 text-xl bg-white" data-k="5">5</button>
            <button class="key rounded-xl py-4 text-xl bg-white" data-k="6">6</button>
            <button class="key rounded-xl py-4 text-xl bg-white" data-k="7">7</button>
            <button class="key rounded-xl py-4 text-xl bg-white" data-k="8">8</button>
            <button class="key rounded-xl py-4 text-xl bg-white" data-k="9">9</button>
            <div></div>
            <button class="key rounded-xl py-4 text-xl bg-white" data-k="0">0</button>
            <div></div>
          </div>
        </div>
      </div>
    </section>

    <!-- FINALE: Party sebelum hadiah -->
    <section id="finale" class="hide">
      <div class="window rounded-2xl overflow-hidden">
        <div class="winbar px-4 py-2">
          <div class="font-semibold text-[var(--choco)]">Saatnya Perayaan ğŸŠ</div>
        </div>
        <div class="p-6 text-center text-[var(--choco)]">
          <div class="text-6xl mb-2 cake-bounce select-none">ğŸ‚</div>
          <!-- <div class="text-sm opacity-70 -mt-2 mb-4 candle-flicker select-none">ğŸ•¯ï¸</div> -->
          <p class="text-2xl font-semibold hb-wave">Happy Birthday, cantiku! ğŸ’–</p>
          <p class="mt-2 opacity-80">Tekan tombol di bawah untuk buka hadiahnya~</p>
          <button id="toPrizeFromFinale" class="btn mt-5 rounded-xl px-6 py-2 font-semibold text-[var(--choco)]">
            Buka Hadiah ğŸ
          </button>
        </div>
      </div>
    </section>

    <!-- HADIAH: POLAROID + NOTE -->
    <section id="prize" class="hide">
      <div class="window rounded-2xl overflow-hidden">
        <div class="winbar px-4 py-2"><div class="font-semibold text-[var(--choco)]">Hadiah untukmu ğŸ’–</div></div>
        <div class="p-4 text-center">
          <img src="assets/polaroid.png" alt="polaroid" class="mx-auto rounded-xl shadow-lg">
          <div class="mt-4 text-[var(--choco)] text-lg leading-relaxed">
            ini dia sesuatu yang aku maksud ğŸ’–<br>
            klik untuk simpan, atau lanjut baca isi hatikuâ€¦
          </div>
          <div class="mt-4 flex gap-3 justify-center">
            <a download href="assets/polaroid.png" class="btn rounded-xl px-5 py-2 font-semibold text-[var(--choco)]">Unduh Polaroid</a>
            <button id="toLetter" class="btn rounded-xl px-5 py-2 font-semibold text-[var(--choco)]">Baca Surat Penuh</button>
          </div>
        </div>
      </div>

      <!-- Kirim WhatsApp -->
      <div class="rounded-2xl border-2 p-4 bg-white/80 max-w-md mx-auto mt-6">
        <h3 class="font-bold text-lg text-[var(--choco)]">Tulis pesan balik buat aku âœï¸</h3>
        <textarea id="waMsg" rows="4" class="mt-3 w-full rounded-xl border p-3" placeholder="Ketik pesan atau kesanmu di sini..."></textarea>
        <div class="mt-3 flex items-center gap-3">
          <button id="sendWA" class="px-4 py-2 rounded-xl border-2 font-semibold bg-amber-200">Kirim via WhatsApp</button>
          <span id="waCount" class="text-sm opacity-70">0/500</span>
        </div>
      </div>
    </section>

    <!-- SURAT PENUH -->
    <section id="letter" class="hide">
      <div class="window rounded-2xl overflow-hidden">
        <div class="winbar px-4 py-2"><div class="font-semibold text-[var(--choco)]">Surat Penuh ğŸ’Œ</div></div>
        <div class="p-6 text-[var(--choco)] leading-relaxed">
          <p>halo cantik, selamat ulang tahun ya sayang ğŸ‰ tepat pada hari ini umur kamu bertambah satu tahun. semoga rezeki kamu selalu dilancarkan dan segala urusan kamu dimudahkan ya sayang.</p>
          <p class="mt-3">maaf yah sayang, aku nggak bisa hadir di sisi kamu pas hari bahagia ini, hanya bisa kasih ucapan dan sedikit hadiah ini dari jauh.</p>
          <p class="mt-3">aku selalu doain buat kamu, semoga kamu sehat-sehat terus di sana, makin bahagia, dan semua yang kamu harapkan bisa tercapai.</p>
          <p class="mt-3">terima kasih sudah menjadi perempuan yang kuat selama ini, terima kasih sudah bertahan sejauh ini, dan terima kasih sudah menjadi perempuanku yang hebat. bahagia selalu ya sayang ğŸ’•ğŸ’</p>
          <div class="mt-4 text-center"><button id="backHome" class="btn rounded-xl px-5 py-2 font-semibold text-[var(--choco)]">Kembali ke awal</button></div>
        </div>
      </div>
    </section>

    <div id="conf" class="confetti"></div>
  </main>

  <!-- === BGM & SFX === -->
  <audio id="popSfx" src="assets/pop.mp3" preload="auto"></audio>
  <audio id="bgmLanding" src="assets/bgm-landing.mp3" preload="auto" loop></audio>
  <audio id="bgmGame1"   src="assets/bgm-game1.mp3"   preload="auto" loop></audio>
  <audio id="bgmGame2"   src="assets/bgm-game2.mp3"   preload="auto" loop></audio> <!-- NEW -->
  <audio id="bgmPrize"   src="assets/bgm-prize.mp3"   preload="auto" loop></audio>

  <audio id="sfxHeart" src="assets/sfx-heart.mp3" preload="auto"></audio>
  <audio id="sfxBomb"  src="assets/sfx-bomb.mp3"  preload="auto"></audio>
  <audio id="sfxWin"   src="assets/sfx-win.mp3"   preload="auto"></audio>

  <script>
    // ====== CONFIG ======
    const WA_NUMBER = "6282138681368"; // ganti nomor kamu (format internasional, tanpa +)
    const ASSETS = {
      photoRound: 'assets/foto-doi-round.jpg',
      bomb: 'assets/foto-kamu-bomb.jpg'
    }
    const game1Config = { durationMs: 25000, targetScore: 15, maxOnScreen: 8, spawnIntervalMs: [450,650], weights:{heart:.62, star:.12, photoRound:.16, bomb:.10}, lives:2, penaltyOnBomb:-1 };
    const game2Config = { durationSec: 60, targetPass: 20, minPassOnTimeOut: 15 };

    // ====== HELPERS ======
    const $ = s=>document.querySelector(s);
    const show = id=>{$('#'+id).classList.remove('hide')};
    const hide = id=>{$('#'+id).classList.add('hide')};
    const rand = (a,b)=>Math.random()*(b-a)+a;
    const randint = (a,b)=>Math.floor(rand(a,b+1));
    function pickWeighted(keys, w){ const r=Math.random(); let acc=0; for(const k of keys){ acc += w[k]; if(r<=acc) return k; } return keys.at(-1); }
    function confetti(){
      const c = $('#conf');
      for(let i=0;i<60;i++){
        const s=document.createElement('span');
        s.textContent = ['ğŸ‰','âœ¨','ğŸ’–','â­'][i%4];
        s.style.left = randint(0,100)+'vw';
        s.style.top = '-10vh';
        s.style.animationDelay = (i*0.01)+'s';
        c.appendChild(s);
        setTimeout(()=>s.remove(),1200);
      }
      $('#popSfx')?.play().catch(()=>{});
    }

    // ====== AUDIO MANAGER ======
    const A = {
      bgmLanding: $('#bgmLanding'),
      bgmGame1:   $('#bgmGame1'),
      bgmGame2:   $('#bgmGame2'), // NEW
      bgmPrize:   $('#bgmPrize'),
      sfxHeart:   $('#sfxHeart'),
      sfxBomb:    $('#sfxBomb'),
      sfxWin:     $('#sfxWin'),
      pop:        $('#popSfx'),
    };

    function safePlay(audio, {volume=1, from=0, loop=null}={}){
      if (!audio) return;
      if (loop !== null) audio.loop = loop;
      audio.volume = volume;
      if (from !== null) audio.currentTime = from;
      audio.play().catch(()=>{});
    }
    function stop(audio, reset=true){
      if (!audio) return;
      audio.pause();
      if (reset) audio.currentTime = 0;
    }
    function fadeTo(audio, target=0.0, ms=300){
      if (!audio) return;
      const steps = Math.max(1, Math.floor(ms/40));
      const start = audio.volume ?? 1;
      const delta = (target - start)/steps;
      let n=0;
      const t = setInterval(()=>{
        n++;
        audio.volume = Math.min(1, Math.max(0, start + delta*n));
        if (n>=steps){ clearInterval(t); if (target===0) { audio.pause(); } }
      }, 40);
    }
    function playLoop(id, vol=0.5, fadeMs=350){
      const el = A[id]; if(!el) return;
      el.loop = true;
      if (el.paused) { el.volume = 0; safePlay(el, {volume:0, from:0, loop:true}); }
      fadeTo(el, vol, fadeMs);
    }
    function playOne(id, vol=0.8){
      const el = A[id]; if(!el) return;
      const c = el.cloneNode(true);
      c.volume = vol; document.body.appendChild(c);
      c.play().catch(()=>{}); c.addEventListener('ended', ()=>c.remove());
    }
    function stopAllBgm(exceptId=null){
      ['bgmLanding','bgmGame1','bgmGame2','bgmPrize'].forEach(k=>{
        if (k!==exceptId) stop(A[k]);
      });
    }
    document.addEventListener('DOMContentLoaded', ()=>{
      if (A.bgmLanding) { safePlay(A.bgmLanding, {volume:.45, from:0, loop:true}); }
    });
    function unlockAudioOnce(){
      const unlock = ()=>{
        if (A.bgmLanding && A.bgmLanding.paused) safePlay(A.bgmLanding, {volume:.5, loop:true});
        ['click','touchstart'].forEach(ev=>document.removeEventListener(ev, unlock));
      };
      ['click','touchstart'].forEach(ev=>document.addEventListener(ev, unlock, {passive:true, once:false}));
    }
    unlockAudioOnce();

    // ====== SWEETALERT IDLE PROMPT ======
    function attachIdlePrompt(scopeEl, {idleMs=12000, text="Yuk main sebentar â¤ï¸"}) {
      let t = null;
      const reset = ()=>{ if(t) clearTimeout(t); t = setTimeout(()=> {
        Swal.fire({
          title: 'Heiiâ€¦',
          text,
          icon: 'info',
          confirmButtonText: 'Siap, lanjut!',
          confirmButtonColor: '#efb6a2',
          width: 360,
          customClass: {popup:'rounded-2xl'}
        });
      }, idleMs); };

      ['pointerdown','keydown','touchstart'].forEach(ev=>{
        scopeEl.addEventListener(ev, reset, {passive:true});
      });
      reset();
      return ()=>{ if(t) clearTimeout(t); };
    }
    let cleanupIdle = null;

    // ====== NAVIGATION ======
    $('#openBtn').addEventListener('click', ()=>{
      hide('landing'); show('card1');
      playLoop('bgmLanding', 0.5, 300);
    });
    $('#toCard2').addEventListener('click', ()=>{ hide('card1'); show('card2'); });
    $('#startG1').addEventListener('click', startGame1);

    $('#giveUpBtn').addEventListener('click', ()=>{ hide('afterG1'); show('giveUp'); });
    $('#giveUpContinue').addEventListener('click', ()=>{ hide('giveUp'); startGame2(); });
    $('#toG2').addEventListener('click', ()=>{ hide('afterG1'); startGame2(); });

    $('#toPrizeFromFinale').addEventListener('click', ()=>{ hide('finale'); show('prize'); });
    $('#toLetter').addEventListener('click', ()=>{ hide('prize'); show('letter'); });
    $('#backHome').addEventListener('click', ()=>{ hide('letter'); show('landing'); });

    // ====== GAME 1 ======
    let g1 = {score:0,time:0,timer:null,spawn:null,on:0,lives:game1Config.lives};
    function startGame1(){
      hide('card2'); show('game1');
      // audio: swap ke BGM Game 1
      fadeTo(A.bgmLanding, 0, 250);
      stopAllBgm('bgmGame1');
      playLoop('bgmGame1', 0.55, 300);

      g1.score=0; g1.time=game1Config.durationMs/1000; g1.on=0; g1.lives = game1Config.lives;
      $('#g1Target').textContent = game1Config.targetScore;
      $('#g1Score').textContent = 0; $('#g1Time').textContent = g1.time;
      const livesWrap = $('#g1LivesWrap'); livesWrap.innerHTML = g1.lives?('â¤ï¸'.repeat(g1.lives)) : '';
      const a = $('#arena'); a.innerHTML='';

      if (cleanupIdle) cleanupIdle();
      cleanupIdle = attachIdlePrompt(a, {idleMs: 12000, text: 'Tap hati/â­ yaaâ€¦ aku nungguin ğŸ˜š'});

      g1.timer = setInterval(()=>{ g1.time--; $('#g1Time').textContent = g1.time; if(g1.time<=0){ endGame1(); } },1000);

      function spawn(){
        if(g1.on>=game1Config.maxOnScreen) return;
        const t = pickWeighted(['heart','star','photoRound','bomb'], game1Config.weights);
        const el=document.createElement('button');
        el.className='fall-item '+t;
        el.style.left = Math.min(92, Math.max(2, randint(2,92)))+'%';
        el.style.animation='fallTop '+(3+Math.random()*1.8)+'s linear forwards';
        if(t==='heart') el.textContent='ğŸ’—';
        if(t==='star') el.textContent='â­';
        if(t==='photoRound') el.style.backgroundImage=`url(${ASSETS.photoRound})`;
        if(t==='bomb') el.style.backgroundImage=`url(${ASSETS.bomb})`;
        el.addEventListener('click',()=>hit(t,el));
        a.appendChild(el); g1.on++;
        el.addEventListener('animationend',()=>{ el.remove(); g1.on--; });
      }
      g1.spawn = setInterval(spawn, randint(game1Config.spawnIntervalMs[0], game1Config.spawnIntervalMs[1]));
    }
    function hit(t, el){
      el.classList.add('pop');
      setTimeout(()=>el.remove(),140);
      g1.on--;
      // SFX tap
      if (t==='bomb'){ playOne('sfxBomb', 0.85); }
      else { playOne('sfxHeart', 0.75); }
      // Skor/lives
      if(t==='heart'){ g1.score+=1; }
      else if(t==='star'){ g1.score+=2; }
      else if(t==='photoRound'){ g1.score+=1; }
      else if(t==='bomb'){
        if(g1.lives>0){
          g1.lives--; $('#g1LivesWrap').textContent = 'â¤ï¸'.repeat(g1.lives);
        } else {
          g1.score += game1Config.penaltyOnBomb; if(g1.score<0) g1.score=0;
        }
      }
      $('#g1Score').textContent = g1.score;
      if(g1.score>=game1Config.targetScore){ endGame1(true); }
    }
    function endGame1(passed=false){
      clearInterval(g1.timer); clearInterval(g1.spawn);
      if (cleanupIdle) { cleanupIdle(); cleanupIdle=null; }
      // TANPA party & TANPA ganti BGM â€” langsung ke afterG1
      hide('game1'); show('afterG1');
    }

    // ====== GAME 2 (Kraepelin) ======
    let g2 = {score:0,time:game2Config.durationSec,ans:null,timer:null};
    function onesDigit(n){ return ((n % 10) + 10) % 10; } // jaga-jaga jika negatif (harusnya gak)
    function nextQ(){
      const a=randint(0,9), b=randint(0,9);
      $('#qA').textContent=a; $('#qB').textContent=b;
      // Kraepelin rule: jawaban = 1 digit terakhir dari penjumlahan
      g2.ans = onesDigit(a + b);
    }
    function startGame2(){
      hide('afterG1'); hide('giveUp'); show('game2');

      // Audio: fade out game1, nyalakan BGM Game 2
      fadeTo(A.bgmGame1, 0, 250);
      stopAllBgm('bgmGame2');
      playLoop('bgmGame2', 0.55, 300);

      g2.score=0; g2.time=game2Config.durationSec;
      $('#g2Score').textContent=0; $('#g2Time').textContent=g2.time;
      nextQ();

      const keys=document.querySelectorAll('#game2 .key');
      keys.forEach(k=>k.onclick=()=>pressKey(k.dataset.k));

      if (cleanupIdle) cleanupIdle();
      cleanupIdle = attachIdlePrompt($('#game2'), {idleMs: 12000, text:'Jawab cepat yaa, waktunya jalan ğŸ˜†'});

      g2.timer=setInterval(()=>{ g2.time--; $('#g2Time').textContent=g2.time; if(g2.time<=0) endGame2(); },1000);
    }
    function pressKey(k){
      // Input 1 digit langsung cek
      checkAns(Number(k));
    }
    function checkAns(val){
      const box=$('#qBox');
      if(val===g2.ans){
        g2.score++; $('#g2Score').textContent=g2.score;
        // Feedback benar ringan (opsional shake kecil)
        box.classList.remove('wrongFlash','shake');
        nextQ();
      } else {
        // Salah: merah + bounce (wrongFlash + shake)
        box.classList.remove('wrongFlash','shake');
        void box.offsetWidth; // reflow untuk restart anim
        box.classList.add('wrongFlash','shake');
        g2.score = Math.max(0, g2.score-1);
        $('#g2Score').textContent=g2.score;
        nextQ();
      }
    }
    function endGame2(){
      clearInterval(g2.timer);
      if (cleanupIdle) { cleanupIdle(); cleanupIdle=null; }
      // TANPA party & TANPA ganti BGM â€” party hanya di Finale
      hide('game2');
      showFinale();
    }

    // ====== FINALE (Party sekali saja, lalu ke Prize) ======
    function showFinale(){
      // Pindah BGM ke prize & PARTY (sekali)
      fadeTo(A.bgmGame2, 0, 300);
      stopAllBgm('bgmPrize');
      playLoop('bgmPrize', 0.45, 400);

      playOne('sfxWin', 0.9); // fanfare
      confetti();             // ini juga memicu pop.mp3
      show('finale');
    }

    // ====== WA Send ======
    const waMsg = $('#waMsg'); const waCount = $('#waCount'); waMsg.maxLength=500;
    waMsg.addEventListener('input',()=>waCount.textContent=`${waMsg.value.length}/500`);
    $('#sendWA').addEventListener('click',()=>{
      const header = "Hai, ini pesanku setelah main gamenya ğŸ’Œ%0A%0A";
      const isi = encodeURIComponent(waMsg.value.trim()||'(kosong)');
      const url = `https://wa.me/${WA_NUMBER}?text=${header}${isi}`;
      window.open(url,'_blank');
    });
  </script>
</body>
</html>

